<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-5661724500759448">
    <title>チケットメーカー</title>
    <style>
        body{font-family:"KozGoPr6N","AR ADGothicJP","YuGothic","Meiryo",sans-serif;margin:0;padding:20px;background:#FFF4F6;color:#F676A6;position:relative;}
        #mainContainer{display:flex;justify-content:space-between;}
        #canvasContainer{width:50%;text-align:center;overflow:auto;}
        #ticketCanvas{border:1px solid #ccc;}
        #controlsContainer{width:45%;overflow-y:auto;max-height:90vh;}
        .input-group{margin:10px 0;}
        .note{color:#F676A6;font-size:14px;}
        .position-input,.spacing-input,.size-input,.line-height-input,.shadow-input,.opacity-input{width:50px;margin-left:5px;display:none;}
        .advanced-mode.active .position-input,.advanced-mode.active .spacing-input,.advanced-mode.active .size-input,.advanced-mode.active .line-height-input,.advanced-mode.active .shadow-input,.advanced-mode.active .opacity-input{display:inline;}
        .advanced-label{display:none;}
        .advanced-mode.active .advanced-label{display:inline;}
        #advancedModeBtn{margin-left:10px;}
        #previewSizeButtons{margin-top:10px;}
        #previewSizeButtons button,.input-group button{margin:0 5px;padding:8px 16px;border-radius:20px;border:none;background:#F676A6;color:#FFF;cursor:pointer;font-family:"KozGoPr6N","AR ADGothicJP","YuGothic","Meiryo",sans-serif;}
        #previewSizeButtons button:hover,.input-group button:hover{background:#E55A8C;}
        .ad-container{text-align:center;margin:20px 0;}
        #languageSelector{position:absolute;top:10px;right:10px;font-family:"KozGoPr6N","AR ADGothicJP","YuGothic","Meiryo",sans-serif;color:#F676A6;}
        #disclaimer{font-size:7pt;color:#F676A6;text-align:center;margin-top:10px;}
        @media (max-width:768px) and (orientation:portrait){#mainContainer{flex-direction:column;}#canvasContainer,#controlsContainer{width:100%;}#canvasContainer{order:2;}#controlsContainer{order:1;}}
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5661724500759448" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div class="ad-container">
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5661724500759448" data-ad-slot="5661724500759448" data-ad-format="auto" data-full-width-responsive="true"></ins>
        <script>(adsbygoogle=window.adsbygoogle||[]).push({});</script>
    </div>
    <select id="languageSelector" onchange="changeLanguage(this.value)">
        <option value="ja" selected>日本語</option><option value="zh-TW">中文（繁體）</option><option value="zh-CN">中文（简体）</option><option value="en">English</option><option value="ko">한국어</option><option value="th">ไทย</option><option value="id">Bahasa Indonesia</option>
    </select>
    <div id="mainContainer">
        <div id="canvasContainer">
            <h1>チケットプレビュー</h1>
            <canvas id="ticketCanvas" aria-label="門票預覽畫布" aria-live="polite"></canvas>
            <div id="previewSizeButtons">
                <button onclick="setPreviewScale(0.12)">12%</button><button onclick="setPreviewScale(0.25)">25%</button><button onclick="setPreviewScale(0.5)">50%</button><button onclick="setPreviewScale(1.0)">100%</button>
            </div>
            <p id="disclaimer">AKB48メンバーの生誕祭劇場公演で、ファンの皆様が復刻した劇場チケットに感動し、趣味としてファンが自作チケットを保存できるウェブサイトを制作いたしました。商業目的や違法な使用はご遠慮ください。権利は© AKB48及び株式会社DHに帰属し、制作者は責任を負いかねます。何卒ご了承ください。</p>
        </div>
        <div id="controlsContainer">
            <h1>オリジナルチケット</h1>
            <div class="input-group advanced-mode">
                <label for="rect1Line1" data-key="rect1Line1">エリア1 テキスト (1行目): </label><input type="text" id="rect1Line1" value="AKB">
                <label class="advanced-label">X: </label><input type="number" id="rect1Line1X" value="13.5" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">Y: </label><input type="number" id="rect1Line1Y" value="12" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">字間: </label><input type="number" id="rect1Spacing" value="-7000" class="spacing-input">
                <label class="advanced-label">サイズ: </label><input type="number" id="rect1Size" value="47" class="size-input"><span class="advanced-label">pt</span><br>
                <label for="rect1Line2" data-key="rect1Line2">エリア1 テキスト (2行目): </label><input type="text" id="rect1Line2" value="48">
                <label class="advanced-label">X: </label><input type="number" id="rect1Line2X" value="13.5" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">Y: </label><input type="number" id="rect1Line2Y" value="24" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">字間: </label><input type="number" id="rect1Line2Spacing" value="-7000" class="spacing-input">
                <label class="advanced-label">サイズ: </label><input type="number" id="rect1Line2Size" value="47" class="size-input"><span class="advanced-label">pt</span><br>
                <label for="rect1Color" data-key="rect1Color">エリア1 背景色: </label><input type="color" id="rect1Color" value="#2086D1">
                <label for="rect1TextColor" data-key="rect1TextColor">エリア1 文字色: </label><input type="color" id="rect1TextColor" value="#FFFFFF"><br>
            </div>
            <div class="input-group advanced-mode">
                <label for="text2" data-key="text2">テキスト2: </label><input type="text" id="text2" value="「ここからだ」 公演">
                <label class="advanced-label">X: </label><input type="number" id="text2X" value="37" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">Y: </label><input type="number" id="text2Y" value="12" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">字間: </label><input type="number" id="text2Spacing" value="2000" class="spacing-input">
                <label class="advanced-label">サイズ: </label><input type="number" id="text2Size" value="14.2" class="size-input"><span class="advanced-label">pt</span><br>
                <label for="text3Line1" data-key="text3Line1">テキスト3 (1行目): </label><input type="text" id="text3Line1" value="秋元康 生誕祭">
                <label class="advanced-label">X: </label><input type="number" id="text3Line1X" value="35" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">Y: </label><input type="number" id="text3Line1Y" value="19" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">字間: </label><input type="number" id="text3Spacing" value="2000" class="spacing-input">
                <label class="advanced-label">サイズ: </label><input type="number" id="text3Size" value="14.2" class="size-input"><span class="advanced-label">pt</span>
                <label class="advanced-label">行間: </label><input type="number" id="text3LineHeight" value="18" class="line-height-input"><span class="advanced-label">pt</span><br>
                <label for="text3Line2" data-key="text3Line2">テキスト3 (2行目): </label><input type="text" id="text3Line2" value="AKB48劇場">
                <label class="advanced-label">X: </label><input type="number" id="text3Line2X" value="35" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">Y: </label><input type="number" id="text3Line2Y" value="25" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">字間: </label><input type="number" id="text3Line2Spacing" value="2000" class="spacing-input">
                <label class="advanced-label">サイズ: </label><input type="number" id="text3Line2Size" value="14.2" class="size-input"><span class="advanced-label">pt</span><br>
                <label for="text4Line1" data-key="text4Line1">テキスト4 (1行目): </label><input type="text" id="text4Line1" value="＜日付＞2025年05月02日（金）">
                <label class="advanced-label">X: </label><input type="number" id="text4Line1X" value="13" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">Y: </label><input type="number" id="text4Line1Y" value="43" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">字間: </label><input type="number" id="text4Spacing" value="1000" class="spacing-input">
                <label class="advanced-label">サイズ: </label><input type="number" id="text4Size" value="11" class="size-input"><span class="advanced-label">pt</span>
                <label class="advanced-label">行間: </label><input type="number" id="text4LineHeight" value="14" class="line-height-input"><span class="advanced-label">pt</span><br>
                <label for="text4Line2" data-key="text4Line2">テキスト4 (2行目): </label><input type="text" id="text4Line2" value="OPEN：18時10分       START：18時30分      ￥3,400"><br>
                <label for="text5" data-key="text5">テキスト5: </label><input type="text" id="text5" value="048番">
                <label class="advanced-label">X: </label><input type="number" id="text5X" value="13" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">Y: </label><input type="number" id="text5Y" value="55" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">字間: </label><input type="number" id="text5Spacing" value="200" class="spacing-input">
                <label class="advanced-label">サイズ: </label><input type="number" id="text5Size" value="16" class="size-input"><span class="advanced-label">pt</span><br>
                <label for="text6" data-key="text6">テキスト6: </label><input type="text" id="text6" value="① ❘ 000－0000 ❘ ゴメン先生 様">
                <label class="advanced-label">X: </label><input type="number" id="text6X" value="36" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">Y: </label><input type="number" id="text6Y" value="55" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">字間: </label><input type="number" id="text6Spacing" value="311" class="spacing-input">
                <label class="advanced-label">サイズ: </label><input type="number" id="text6Size" value="13" class="size-input"><span class="advanced-label">pt</span><br>
                <label for="textColor" data-key="textColor">文字色 (2-6): </label><input type="color" id="textColor" value="#000000"><br>
            </div>
            <div class="input-group advanced-mode">
                <label for="bgColor" data-key="bgColor">全体の背景色: </label><input type="color" id="bgColor" value="#E5EDF9"><br>
                <label for="bgText" data-key="bgText">背景テキスト: </label><input type="text" id="bgText" value="AKB48">
                <label class="advanced-label">X: </label><input type="number" id="bgTextX" value="-100" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">Y: </label><input type="number" id="bgTextY" value="0" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">字間: </label><input type="number" id="bgTextSpacing" value="-6000" class="spacing-input">
                <label class="advanced-label">行間: </label><input type="number" id="bgTextLineHeight" value="46" class="line-height-input"><span class="advanced-label">pt</span>
                <label class="advanced-label">サイズ: </label><input type="number" id="bgTextSize" value="62" class="size-input"><span class="advanced-label">pt</span><br>
                <label for="bgTextColor" data-key="bgTextColor">背景文字色: </label><input type="color" id="bgTextColor" value="#FFFFFF">
                <label for="bgShadowColor" data-key="bgShadowColor">背景影の色: </label><input type="color" id="bgShadowColor" value="#5F96ED">
                <label class="advanced-label">シャドウX: </label><input type="number" id="bgShadowX" value="0.5" step="0.1" class="shadow-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">シャドウY: </label><input type="number" id="bgShadowY" value="-0.4" step="0.1" class="shadow-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">シャドウ透明度: </label><input type="number" id="bgShadowOpacity" value="0.2" min="0" max="1" step="0.1" class="opacity-input"><span class="advanced-label">（0-1）</span><br>
            </div>
            <div class="input-group advanced-mode">
                <label for="rect9Color" data-key="rect9Color">エリア9 背景色: </label><input type="color" id="rect9Color" value="#2086D1"><br>
                <label for="text10" data-key="text10">テキスト10: </label><input type="text" id="text10" value="<主催 ‧ お問い合せ>">
                <label class="advanced-label">X: </label><input type="number" id="text10X" value="54" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">Y: </label><input type="number" id="text10Y" value="62.5" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">字間: </label><input type="number" id="text10Spacing" value="236" class="spacing-input">
                <label class="advanced-label">サイズ: </label><input type="number" id="text10Size" value="7" class="size-input"><span class="advanced-label">pt</span><br>
                <label for="text11" data-key="text11">テキスト11: </label><input type="text" id="text11" value="AKB48 Theater">
                <label class="advanced-label">X: </label><input type="number" id="text11X" value="80.5" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">Y: </label><input type="number" id="text11Y" value="63" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">字間: </label><input type="number" id="text11Spacing" value="238" class="spacing-input">
                <label class="advanced-label">サイズ: </label><input type="number" id="text11Size" value="10" class="size-input"><span class="advanced-label">pt</span><br>
                <label for="text12" data-key="text12">テキスト12: </label><input type="text" id="text12" value="TEL:03-5298-8648">
                <label class="advanced-label">X: </label><input type="number" id="text12X" value="108" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">Y: </label><input type="number" id="text12Y" value="63" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">字間: </label><input type="number" id="text12Spacing" value="236" class="spacing-input">
                <label class="advanced-label">サイズ: </label><input type="number" id="text12Size" value="12.5" class="size-input"><span class="advanced-label">pt</span><br>
                <label for="footerTextColor" data-key="footerTextColor">文字色 (10-12): </label><input type="color" id="footerTextColor" value="#FFFFFF"><br>
            </div>
            <div class="input-group advanced-mode">
                <label for="bgImageInput" data-key="bgImageInput">背景図または装飾図: </label><input type="file" id="bgImageInput" accept="image/*"><br>
                <label for="bgImageLayer" data-key="bgImageLayer">レイヤー順序: </label>
                <select id="bgImageLayer">
                    <option value="background">背景</option>
                    <option value="foreground">前景</option>
                </select><br>
                <label class="advanced-label">X: </label><input type="number" id="bgImageX" value="0" class="position-input"><span class="advanced-label">mm</span>
                <label class="advanced-label">Y: </label><input type="number" id="bgImageY" value="0" class="position-input"><span class="advanced-label">mm</span>
            </div>
            <div class="input-group">
                <label for="qrCodeInput" data-key="qrCodeInput">QRコード画像 (優先): </label><input type="file" id="qrCodeInput" accept="image/*"><br>
                <label for="showQR" data-key="showQR"><input type="checkbox" id="showQR" checked> QRコード枠を表示</label><br>
                <label for="qrSquareColor" data-key="qrSquareColor">QR枠の色: </label><input type="color" id="qrSquareColor" value="#2086D1"><br>
            </div>
            <div class="input-group">
                <label for="bleedOption" data-key="bleedOption"><input type="checkbox" id="bleedOption"> 裁ち落とし付き (+3mm)</label>
            </div>
            <div class="input-group">
                <button onclick="downloadTicket(300)" data-key="download300" aria-label="下載 300 DPI 門票">ダウンロード (300 DPI)</button>
                <button onclick="downloadTicket(70)" data-key="download70" aria-label="下載 70 DPI 門票">ダウンロード (70 DPI)</button>
                <button id="advancedModeBtn" onclick="toggleAdvancedMode()" data-key="advancedMode" aria-expanded="false">詳細設定</button>
                <button onclick="window.open('https://paypal.me/gomensensei?country.x=HK&locale.x=zh_HK','_blank')" data-key="donate">寄付する</button>
            </div>
            <p class="note" data-key="note">※ダウンロードしたPNGはRGBです。印刷用にCMYKへ変換するにはPhotoshopかGIMPをご利用ください。</p>
        </div>
    </div>
    <div class="ad-container">
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5661724500759448" data-ad-slot="5661724500759448" data-ad-format="auto" data-full-width-responsive="true"></ins>
        <script>(adsbygoogle=window.adsbygoogle||[]).push({});</script>
    </div>
    <script>
        const $ = id => document.getElementById(id);
        const canvas = $('ticketCanvas');
        const ctx = canvas.getContext('2d');
        const fonts = {
            avant: 'ITC Avant Garde Gothic Std Extra Light, sans-serif',
            kozgo: 'KozGoPr6N, YuGothic, sans-serif',
            ar: 'AR ADGothicJP, MS PGothic, sans-serif'
        };
        const sizes = { base: { w: 150, h: 65 }, bleed: 3 };
        const dpi = {
            300: {
                base: { w: sizes.base.w * 300 / 25.4, h: sizes.base.h * 300 / 25.4 },
                bleed: { w: (sizes.base.w + 2 * sizes.bleed) * 300 / 25.4, h: (sizes.base.h + 2 * sizes.bleed) * 300 / 25.4 }
            },
            70: {
                base: { w: sizes.base.w * 70 / 25.4, h: sizes.base.h * 70 / 25.4 },
                bleed: { w: (sizes.base.w + 2 * sizes.bleed) * 70 / 25.4, h: (sizes.base.h + 2 * sizes.bleed) * 70 / 25.4 }
            }
        };
        let qrImage = null, bgImage = null, previewScale = 0.5;

        const langs = {
            ja: { title: 'チケットメーカー', preview: 'チケットプレビュー', custom: 'オリジナルチケット', rect1Line1: 'エリア1 テキスト (1行目)', rect1Line2: 'エリア1 テキスト (2行目)', rect1Color: 'エリア1 背景色', rect1TextColor: 'エリア1 文字色', text2: 'テキスト2', text3Line1: 'テキスト3 (1行目)', text3Line2: 'テキスト3 (2行目)', text4Line1: 'テキスト4 (1行目)', text4Line2: 'テキスト4 (2行目)', text5: 'テキスト5', text6: 'テキスト6', textColor: '文字色 (2-6)', bgColor: '全体の背景色', bgText: '背景テキスト', bgTextColor: '背景文字色', bgShadowColor: '背景影の色', rect9Color: 'エリア9 背景色', text10: 'テキスト10', text11: 'テキスト11', text12: 'テキスト12', footerTextColor: '文字色 (10-12)', qrCodeInput: 'QRコード画像 (優先)', showQR: 'QRコード枠を表示', qrSquareColor: 'QR枠の色', bleedOption: '裁ち落とし付き (+3mm)', download300: 'ダウンロード (300 DPI)', download70: 'ダウンロード (70 DPI)', advancedMode: '詳細設定', donate: '寄付する', note: '※ダウンロードしたPNGはRGBです。印刷用にCMYKへ変換するにはPhotoshopかGIMPをご利用ください。', disclaimer: 'AKB48メンバーの生誕祭劇場公演で、ファンの皆様が復刻した劇場チケットに感動し、趣味としてファンが自作チケットを保存できるウェブサイトを制作いたしました。商業目的や違法な使用はご遠慮ください。権利は© AKB48及び株式会社DHに帰属し、制作者は責任を負いかねます。何卒ご了承ください。', bgImageInput: '背景図または装飾図', bgImageLayer: 'レイヤー順序', bgImageX: 'X', bgImageY: 'Y' },
            'zh-TW': { title: '門票生成器', preview: '門票預覽', custom: '自訂門票', rect1Line1: '矩形1文字 (行1)', rect1Line2: '矩形1文字 (行2)', rect1Color: '矩形1顏色', rect1TextColor: '矩形1文字顏色', text2: '文字2', text3Line1: '文字3 (行1)', text3Line2: '文字3 (行2)', text4Line1: '文字4 (行1)', text4Line2: '文字4 (行2)', text5: '文字5', text6: '文字6', textColor: '文字顏色 (2-6)', bgColor: '背景顏色', bgText: '背景文字', bgTextColor: '背景文字顏色', bgShadowColor: '背景陰影顏色', rect9Color: '矩形9顏色', text10: '文字10', text11: '文字11', text12: '文字12', footerTextColor: '文字顏色 (10-12)', qrCodeInput: 'QR Code 上傳（優先使用）', showQR: '顯示 QR Code 正方形', qrSquareColor: '正方形顏色', bleedOption: '包含出血位 (每邊 +3mm)', download300: '下載門票 (300 DPI)', download70: '下載門票 (70 DPI)', advancedMode: '進階模式', donate: '捐贈', note: '注意：下載的 PNG 為 RGB 模式。為印刷準備，請使用 Photoshop 或 GIMP 轉為 CMYK。', disclaimer: '有鑑於AKB48成員的生誕祭劇場公演中，粉絲製作的應援品包括已不再印刷的實體劇場門票復刻版，因此突發奇想製作此網站，讓粉絲們能自製心目中的票券並自行保存。此網站純粹出於興趣製作，請勿用於商業或其他非法用途。所有權利歸© AKB48及株式会社DH所有，本人對一切責任免責，請注意。', bgImageInput: '背景圖或裝飾圖', bgImageLayer: '圖層順序', bgImageX: 'X', bgImageY: 'Y' },
            // 其他語言省略，可自行補充
        };

        const drawText = (lines, x, y, font, size, spacing, height, color, align = 'left', altFont, dpiVal = 300) => {
            const ptPx = dpiVal / 72;
            ctx.fillStyle = color;
            ctx.textAlign = align;
            lines.forEach((l, i) => {
                let cx = x, ly = y + i * height * ptPx;
                l.split('').forEach(c => {
                    const isAlt = altFont && /[A-Za-z0-9①❘－]/.test(c);
                    ctx.font = `${size * ptPx}px ${isAlt ? altFont : font}`;
                    ctx.fillText(c, cx, ly);
                    cx += ctx.measureText(c).width + spacing * ptPx / 1000;
                });
            });
        };

        const drawTicket = (dpiVal) => {
            const bleed = $('bleedOption').checked;
            const w = bleed ? dpi[dpiVal].bleed.w : dpi[dpiVal].base.w;
            const h = bleed ? dpi[dpiVal].bleed.h : dpi[dpiVal].base.h;
            const mmPx = dpiVal / 25.4;
            canvas.width = w;
            canvas.height = h;
            canvas.style.width = `${w * previewScale}px`;
            canvas.style.height = `${h * previewScale}px`;
            ctx.clearRect(0, 0, w, h);

            ctx.fillStyle = $('bgColor').value;
            ctx.fillRect(0, 0, w, h);

            if (bgImage && $('bgImageLayer').value === 'background') {
                const x = parseFloat($('bgImageX').value) * mmPx + (bleed ? 3 * mmPx : 0);
                const y = parseFloat($('bgImageY').value) * mmPx + (bleed ? 3 * mmPx : 0);
                ctx.drawImage(bgImage, x, y, bgImage.width * mmPx / 25.4, bgImage.height * mmPx / 25.4);
            }

            const bg = { t: $('bgText').value || 'AKB48', x: parseFloat($('bgTextX').value) * mmPx + (bleed ? 3 * mmPx : 0), y: parseFloat($('bgTextY').value) * mmPx + (bleed ? 3 * mmPx : 0), s: parseFloat($('bgTextSpacing').value), lh: parseFloat($('bgTextLineHeight').value), sz: parseFloat($('bgTextSize').value) };
            ctx.font = `${bg.sz * (dpiVal / 72)}px ${fonts.avant}`;
            const cw = ctx.measureText(bg.t.charAt(0)).width, tw = ctx.measureText(bg.t).width, gx = tw + bg.s * (dpiVal / 72) / 1000, gy = bg.lh * (dpiVal / 72);
            ctx.globalAlpha = parseFloat($('bgShadowOpacity').value);
            ctx.fillStyle = $('bgShadowColor').value;
            ctx.shadowColor = $('bgShadowColor').value;
            ctx.shadowOffsetX = parseFloat($('bgShadowX').value) * mmPx;
            ctx.shadowOffsetY = parseFloat($('bgShadowY').value) * mmPx;
            for (let y = bg.y, r = 0; y < h; y += gy, r++) for (let x = bg.x + r * cw; x < w; x += gx) ctx.fillText(bg.t, x, y);
            ctx.globalAlpha = 1;
            ctx.shadowOffsetX = ctx.shadowOffsetY = 0;
            ctx.fillStyle = $('bgTextColor').value;
            for (let y = bg.y, r = 0; y < h; y += gy, r++) for (let x = bg.x + r * cw; x < w; x += gx) ctx.fillText(bg.t, x, y);

            ctx.fillStyle = $('rect1Color').value;
            ctx.fillRect(8 * mmPx + (bleed ? 3 * mmPx : 0), bleed ? 3 * mmPx : 0, 25 * mmPx, 35 * mmPx);
            drawText([$('rect1Line1').value], parseFloat($('rect1Line1X').value) * mmPx + (bleed ? 3 * mmPx : 0), parseFloat($('rect1Line1Y').value) * mmPx + (bleed ? 3 * mmPx : 0), fonts.avant, parseFloat($('rect1Size').value), parseFloat($('rect1Spacing').value), 0, $('rect1TextColor').value, 'center', null, dpiVal);
            drawText([$('rect1Line2').value], parseFloat($('rect1Line2X').value) * mmPx + (bleed ? 3 * mmPx : 0), parseFloat($('rect1Line2Y').value) * mmPx + (bleed ? 3 * mmPx : 0), fonts.avant, parseFloat($('rect1Line2Size').value), parseFloat($('rect1Line2Spacing').value), 0, $('rect1TextColor').value, 'center', null, dpiVal);

            const tc = $('textColor').value;
            drawText([$('text2').value], parseFloat($('text2X').value) * mmPx + (bleed ? 3 * mmPx : 0), parseFloat($('text2Y').value) * mmPx + (bleed ? 3 * mmPx : 0), fonts.kozgo, parseFloat($('text2Size').value), parseFloat($('text2Spacing').value), 0, tc, 'left', fonts.ar, dpiVal);
            drawText([$('text3Line1').value], parseFloat($('text3Line1X').value) * mmPx + (bleed ? 3 * mmPx : 0), parseFloat($('text3Line1Y').value) * mmPx + (bleed ? 3 * mmPx : 0), fonts.kozgo, parseFloat($('text3Size').value), parseFloat($('text3Spacing').value), 0, tc, 'left', fonts.ar, dpiVal);
            drawText([$('text3Line2').value], parseFloat($('text3Line2X').value) * mmPx + (bleed ? 3 * mmPx : 0), parseFloat($('text3Line2Y').value) * mmPx + (bleed ? 3 * mmPx : 0), fonts.kozgo, parseFloat($('text3Line2Size').value), parseFloat($('text3Line2Spacing').value), 0, tc, 'left', fonts.ar, dpiVal);
            drawText([$('text4Line1').value, $('text4Line2').value], parseFloat($('text4Line1X').value) * mmPx + (bleed ? 3 * mmPx : 0), parseFloat($('text4Line1Y').value) * mmPx + (bleed ? 3 * mmPx : 0), fonts.kozgo, parseFloat($('text4Size').value), parseFloat($('text4Spacing').value), parseFloat($('text4LineHeight').value), tc, 'left', fonts.ar, dpiVal);
            drawText([$('text5').value], parseFloat($('text5X').value) * mmPx + (bleed ? 3 * mmPx : 0), parseFloat($('text5Y').value) * mmPx + (bleed ? 3 * mmPx : 0), fonts.kozgo, parseFloat($('text5Size').value), parseFloat($('text5Spacing').value), 27, tc, 'left', fonts.ar, dpiVal);
            drawText([$('text6').value], parseFloat($('text6X').value) * mmPx + (bleed ? 3 * mmPx : 0), parseFloat($('text6Y').value) * mmPx + (bleed ? 3 * mmPx : 0), fonts.kozgo, parseFloat($('text6Size').value), parseFloat($('text6Spacing').value), 27, tc, 'left', fonts.ar, dpiVal);

            ctx.fillStyle = $('rect9Color').value;
            ctx.fillRect(bleed ? 3 * mmPx : 0, 58 * mmPx + (bleed ? 3 * mmPx : 0), 150 * mmPx, 7 * mmPx);
            const fc = $('footerTextColor').value;
            drawText([$('text10').value], parseFloat($('text10X').value) * mmPx + (bleed ? 3 * mmPx : 0), parseFloat($('text10Y').value) * mmPx + (bleed ? 3 * mmPx : 0), fonts.kozgo, parseFloat($('text10Size').value), parseFloat($('text10Spacing').value), 0, fc, 'left', fonts.ar, dpiVal);
            drawText([$('text11').value], parseFloat($('text11X').value) * mmPx + (bleed ? 3 * mmPx : 0), parseFloat($('text11Y').value) * mmPx + (bleed ? 3 * mmPx : 0), fonts.kozgo, parseFloat($('text11Size').value), parseFloat($('text11Spacing').value), 0, fc, 'left', fonts.ar, dpiVal);
            drawText([$('text12').value], parseFloat($('text12X').value) * mmPx + (bleed ? 3 * mmPx : 0), parseFloat($('text12Y').value) * mmPx + (bleed ? 3 * mmPx : 0), fonts.kozgo, parseFloat($('text12Size').value), parseFloat($('text12Spacing').value), 0, fc, 'left', fonts.ar, dpiVal);

            if ($('showQR').checked) {
                ctx.fillStyle = $('qrSquareColor').value;
                const qx = w - 8.5 * mmPx - 23 * mmPx + (bleed ? 3 * mmPx : 0), qy = 23 * mmPx + (bleed ? 3 * mmPx : 0), qs = 23 * mmPx;
                ctx.fillRect(qx, qy, qs, qs);
                if (qrImage) ctx.drawImage(qrImage, qx, qy, qs, qs);
            }

            if (bgImage && $('bgImageLayer').value === 'foreground') {
                const x = parseFloat($('bgImageX').value) * mmPx + (bleed ? 3 * mmPx : 0);
                const y = parseFloat($('bgImageY').value) * mmPx + (bleed ? 3 * mmPx : 0);
                ctx.drawImage(bgImage, x, y, bgImage.width * mmPx / 25.4, bgImage.height * mmPx / 25.4);
            }
        };

        const setPreviewScale = s => { previewScale = s; drawTicket(300); };

        const downloadTicket = dpiVal => {
            drawTicket(dpiVal);
            const l = document.createElement('a');
            l.download = `ticket_${dpiVal}dpi${$('bleedOption').checked ? '_with_bleed' : ''}.png`;
            try {
                const dataUrl = canvas.toDataURL('image/png', 1.0);
                if (!dataUrl || dataUrl === 'data:,') {
                    throw new Error('無法生成圖片數據');
                }
                l.href = dataUrl;
                l.click();
            } catch (e) {
                alert(`下載失敗：${e.message || '未知錯誤'}。請嘗試降低DPI或檢查瀏覽器設置。`);
            }
            drawTicket(300);
        };

        const loadFont = (family, url) => {
            if (!document.fonts.check(`47pt ${family}`)) {
                const font = new FontFace(family, `url(${url}) format('woff2')`);
                return font.load().then(() => {
                    document.fonts.add(font);
                    console.log(`${family} 加載完成`);
                }).catch(err => console.error(`${family} 加載失敗: ${err}`));
            }
            return Promise.resolve();
        };

        $('qrCodeInput').addEventListener('change', e => {
            const f = e.target.files[0];
            if (f && f.type.startsWith('image/')) {
                const r = new FileReader();
                r.onload = ev => {
                    qrImage = new Image();
                    qrImage.src = ev.target.result;
                    qrImage.onload = () => drawTicket(300);
                };
                r.readAsDataURL(f);
            }
        });

        $('bgImageInput').addEventListener('change', e => {
            const f = e.target.files[0];
            if (f && f.type.startsWith('image/')) {
                const r = new FileReader();
                r.onload = ev => {
                    bgImage = new Image();
                    bgImage.src = ev.target.result;
                    bgImage.onload = () => drawTicket(300);
                };
                r.readAsDataURL(f);
            }
        });

        let timeout;
        const debounceDraw = () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => drawTicket(300), 300);
        };

        document.querySelectorAll('input[type="number"]').forEach(i => {
            i.addEventListener('input', (e) => {
                const isSpacing = e.target.classList.contains('spacing-input');
                const minValue = isSpacing ? -10000 : 0;
                if (parseFloat(e.target.value) < minValue) {
                    e.target.value = minValue;
                }
                debounceDraw();
            });
        });

        document.querySelectorAll('input:not([type="number"]), select').forEach(i => {
            i.addEventListener('input', debounceDraw);
        });

        const toggleAdvancedMode = () => {
            document.querySelectorAll('.advanced-mode').forEach(g => g.classList.toggle('active'));
            const b = $('advancedModeBtn'), l = document.documentElement.lang;
            const isActive = b.getAttribute('aria-expanded') === 'true';
            b.setAttribute('aria-expanded', !isActive);
            b.textContent = isActive ? langs[l]?.advancedMode || '詳細設定' : (l === 'ja' ? '詳細設定を閉じる' : '關閉進階模式');
        };

        const changeLanguage = l => {
            document.documentElement.lang = l;
            document.title = langs[l]?.title || 'チケットメーカー';
            $('canvasContainer').querySelector('h1').textContent = langs[l]?.preview || 'チケットプレビュー';
            $('controlsContainer').querySelector('h1').textContent = langs[l]?.custom || 'オリジナルチケット';
            document.querySelectorAll('[data-key]').forEach(e => {
                const k = e.getAttribute('data-key'), t = langs[l]?.[k];
                if (t) e.tagName === 'LABEL' ? e.childNodes[0].textContent = `${t}: ` : e.tagName === 'BUTTON' ? e.textContent = t : e.classList.contains('note') && (e.textContent = t);
            });
            $('disclaimer').textContent = langs[l]?.disclaimer || langs.ja.disclaimer;
        };

        Promise.all([
            loadFont('ITC Avant Garde Gothic Std Extra Light', 'fonts/ITC Avant Garde Gothic Std Extra Light.woff2?v=1.0'),
            loadFont('AR ADGothicJP', 'fonts/jadhei01m.woff2?v=1.0'),
            loadFont('KozGoPr6N', 'fonts/KozGoPr6N-Medium.woff2?v=1.0')
        ]).then(() => drawTicket(300));
    </script>
</body>
</html>
